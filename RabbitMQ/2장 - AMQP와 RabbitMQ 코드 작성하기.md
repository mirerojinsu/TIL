## AMQP와 RabbitMQ 코드 작성하기

### 2.1 RPC 전송으로서의 AMQP
- RabbitMQ 는 거의 모든 부분에서 RPC (Remote Procedure Call) 패턴으로 엄격하게 통신한다.
- 웹 API와는 다르게 AMQP 스펙은 서버와 클라이언트 모두 명령을 실행할 수 있다. (양방향)

### 2.1.1 대화 시작하기
클라이언트 -> [프로토콜 헤더] -> RabbitMQ
클라이언트 <- [Connection.Start] <- RabbitMQ
클라이언트 -> [Connection.StartOK] -> RabbitMQ

### 2.1.2 올바른 채널로 튜닝
- 채널은 협상이 완료된 AMQP 연결을 정보 전송을 위한 수도관철머 사용.
- 양방향이 가능하며, 다른 채널로부터 전송을 격리.
- 단일 AMQP 연결에는 여러 채널이 있음 => **멀티플렉싱**

> 각 채널마다 메모리 구조와 객체가 설정돼 있기 때문에 채널이 많을수록 그 연결에 대한 메시지 흐름을 관리하는 데 더 많은 메모리를 사용한다. 따라서 적당한 채널 사용이 중요하다.

```
마샬링이란?

데이터를 한 프로그램이나 시스템에서 다른 프로그램이나 시스템으로 전달 가능하도록 변환하는 작업이다. 
'직렬화'와 거의 같은 의미로 사용된다.
ex) Java 객체 → JSON 문자열로 변환

반대 과정을 언마샬링 또는 '역직렬화' 라고 한다.
```

### 2.2 AMQP의 RPC 프레임 구조
위에서 살펴봤던 Connection.Start 는 [클래스].[메소드] 형식이며, AMQP 스펙에는 많은 명령어들이 있다. 

### 2.2.1 AMQP 프레임 컴포넌트
AMQP 프레임
- 프레임 헤더
    - 프레임 유형
    - 채널 번호
    - 프레임 크기 (본문의 크기)
- 프레임 페이로드
- 끝 바이트 표식

### 2.2.3 메시지를 프레임으로 마샬링하기
1. 메소드 프레임
    - 익스체인지와 라우팅키를 함께 전송
2. 콘텐츠 헤더 프레임
    - 본문 크기, 메시지 속성
    - 최대 프레임 크기가 넘어가면 여러 개의 바디 프레임으로 쪼개져 전송된다. 
3. 바디 프레임

- 메소드 프레임 및 콘텐츠 헤더 프레임과 달리 바디 프레임 내부의 전달되는 메시지 내용은 어떤 방식으로도 압축되거나 인코딩돼 있지 않으며 `일반텍스트`에서 `이진 이미지 데이터`에 이르기 까지 다양한 형태가 저장될 수 있다. 


### 2.2.4 메소드 프레임 해부하기

### 2.2.5 콘텐츠 헤더 프레임
- RabbitMQ 서버와 메시지를 수신하는 애플리케이션 사이에 주고받는 메시지를 설명하는 속성을 포함 (Basic.Properties 테이블)

### 2.2.6 바디 프레임
- 전송되는 데이터 유형에 대해 독립적
- JPEG 이미지나 JSON 또는 XMl 형식으로 직렬화한 데이터 전송 가능

### 2.3 프로토콜 사용하기

### 2.3.1 익스체인지 선언
- 선언: Exchange.Declare => Exchange.DelareOk

### 2.3.2 큐 선언하기
- 선언: Queue.Declare
- 중볻된 큐 선언하면 중복된 큐 선언을 감지하고, 큐에 대기 중인 메시지의 수와 구독 중인 구독자의 수를 반환

### 2.3.3 큐와 익스체인지 연결하기
- 연결: Queue.Bind -> Queue.BindOk

### 2.3.4 RabbitMQ에 메시지 발행하기
- **실제 메시지가 큐에 들어가는 것이 아닌, 메시지에 대한 참조가 큐에 추가**된다. 실제로 전달할 땐 이 참조를 사용해 메시지를 마샬링하고 클라이언트에 전송한다.
- 하나의메시지가 여러 목적지에 발행될 때 **인스턴스의 참조만 저장하므로 실제 메모리를 적게 사용**하게 된다.

### 2.3.5 RabbitMQ에서 메시지 소비하기
- Basic.Consume
- RabbitMQ가 메시지를 보내는 동안에 명령이 비동기적으로 실행된다.
   - 즉, 소비자는 메시지를 처리하는 소비 함수를 호출하고 메시지가 처리되는 동안 다른 작업도 가능하다. 

---

### 실습 환경은 Spring Boot 환경에서 진행
- 링크크
